<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mundo Alice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style type="text/tailwindcss">
        body { @apply bg-stone-100 text-gray-700 font-sans overflow-x-hidden; }
        .card { @apply bg-white p-5 rounded-3xl shadow-sm border border-stone-200; }
        .input-style { @apply w-full border border-stone-300 rounded-xl p-3 text-sm bg-stone-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all disabled:bg-stone-200 disabled:text-stone-500 disabled:cursor-not-allowed; }
        .label-style { @apply block text-xs font-bold text-emerald-800 uppercase tracking-wide mb-1; }
        
        /* SIDEBAR */
        .sidebar { @apply fixed inset-y-0 left-0 w-72 bg-emerald-900 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-50 shadow-2xl flex flex-col; }
        .sidebar.open { @apply translate-x-0; }
        .overlay { @apply fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm; }
        .overlay.open { @apply block opacity-100; }
        .menu-item { @apply flex items-center gap-3 px-6 py-4 hover:bg-emerald-800 transition cursor-pointer border-b border-emerald-800/30 text-emerald-100; }
        .menu-item.active { @apply bg-emerald-800 text-white border-l-4 border-l-stone-100 font-bold; }

        /* MODAL */
        .modal-bg { @apply fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300; }
        .modal-bg.open { @apply block opacity-100; }
        .modal-box { @apply bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl transform scale-95 transition-transform; }
        .modal-bg.open .modal-box { @apply scale-100; }

        /* BOTOES */
        .filter-btn { @apply px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all whitespace-nowrap; }
        .filter-active { @apply bg-emerald-800 text-white; }
        .filter-inactive { @apply bg-stone-200 text-gray-500 hover:bg-stone-300; }
        .btn-primary { @apply w-full bg-emerald-700 text-white py-3 rounded-xl font-bold hover:bg-emerald-800 transition-all shadow-sm active:scale-95 disabled:bg-gray-400 disabled:scale-100; }
        .btn-big { @apply w-full bg-emerald-700 text-white font-black py-4 rounded-2xl shadow-md hover:bg-emerald-800 transition-all active:scale-95 text-lg uppercase; }
        .btn-size-select { @apply bg-stone-100 hover:bg-emerald-100 hover:text-emerald-700 hover:border-emerald-300 border-2 border-transparent text-gray-600 font-bold py-3 rounded-xl transition; }
        .btn-delete { @apply text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded hover:bg-red-50 transition; }
        
        .hidden { display: none !important; }
        .list-item-row { @apply flex justify-between items-center bg-stone-50 p-3 rounded-xl border border-stone-200 text-sm mb-2; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-stone-100 flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[40px] shadow-xl w-full max-w-md text-center border border-stone-200">
            <span class="text-6xl">üë∂</span>
            <h2 class="text-3xl font-bold text-emerald-800 mt-4 mb-8">Mundo Alice</h2>
            <div class="space-y-5 text-left">
                <div><label class="label-style">Email</label><input type="email" id="login-email" class="input-style"></div>
                <div><label class="label-style">Senha</label><input type="password" id="login-password" class="input-style"></div>
                <button onclick="handleLogin()" class="btn-primary mt-4">Entrar</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"></p>
            </div>
        </div>
    </div>

    <div id="diaper-modal" class="modal-bg">
        <div class="modal-box">
            <h3 class="text-xl font-bold text-emerald-800 mb-2 text-center">Qual tamanho usou?</h3>
            <p class="text-xs text-gray-500 text-center mb-6">Isso remover√° 1 unidade do estoque.</p>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="confirmDiaperUsage('RN')" class="btn-size-select">RN</button>
                <button onclick="confirmDiaperUsage('P')" class="btn-size-select">P</button>
                <button onclick="confirmDiaperUsage('M')" class="btn-size-select">M</button>
                <button onclick="confirmDiaperUsage('G')" class="btn-size-select">G</button>
                <button onclick="confirmDiaperUsage('XG')" class="btn-size-select">XG</button>
                <button onclick="confirmDiaperUsage('XXG')" class="btn-size-select">XXG</button>
            </div>
            <button onclick="closeDiaperModal()" class="w-full text-gray-400 text-sm py-2 hover:text-gray-600">Cancelar</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        
        <div id="overlay" class="overlay" onclick="toggleMenu()"></div>
        <aside id="sidebar" class="sidebar">
            <div class="p-6 text-2xl font-bold border-b border-emerald-800 flex justify-between items-center bg-emerald-950">
                <span>Menu</span><button onclick="toggleMenu()" class="text-emerald-300 hover:text-white">‚úï</button>
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <div onclick="switchTab('estoque')" class="menu-item active" id="link-estoque">üì¶ Estoque & Compras</div>
                <div onclick="switchTab('saude')" class="menu-item" id="link-saude">üè• Sa√∫de & Crescimento</div>
                <div onclick="switchTab('rotina')" class="menu-item" id="link-rotina">‚è∞ Rotina (Sono/Mamar)</div>
                <div onclick="switchTab('wish')" class="menu-item" id="link-wish">‚ú® Lista de Desejos</div>
                <div onclick="switchTab('profile')" class="menu-item" id="link-profile">ü™™ Perfil & Documentos</div>
            </nav>
            <div class="p-6 border-t border-emerald-800 bg-emerald-950">
                <p id="user-role-display" class="text-xs text-emerald-400 text-center mb-2">Visitante</p>
                <button onclick="toggleAvoMode()" id="avo-btn" class="w-full mb-4 text-xs bg-emerald-800 py-3 rounded-lg text-center hover:bg-emerald-700 transition font-bold">Modo Av√≥s: OFF</button>
                <button onclick="handleLogout()" class="w-full text-xs text-emerald-300 hover:text-white underline">Sair do App</button>
            </div>
        </aside>

        <header class="bg-white border-b border-stone-200 sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button onclick="toggleMenu()" class="p-2 -ml-2 text-emerald-800 rounded-lg hover:bg-stone-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <div><h1 class="text-lg font-bold text-emerald-800 leading-tight">Mundo Alice</h1><p class="text-[10px] text-gray-400 font-medium">Minha sorte disfar√ßada em pessoa!</p></div>
                </div>
                <div id="clock-display" class="text-right bg-stone-50 px-3 py-1 rounded-lg border border-stone-100">
                    <p class="text-[9px] text-gray-400 uppercase tracking-wider font-bold">Tempo</p><p id="timer-val" class="text-xs font-bold text-emerald-600 tabular-nums">--</p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 lg:p-6">
            
            <div id="tab-estoque" class="tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div class="card p-4 text-center"><p class="text-[10px] uppercase text-gray-400">Falta Comprar</p><p id="future-cost" class="text-xl font-bold text-gray-800">R$ 0</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] uppercase text-gray-400">M√©dia Real</p><p id="media-val" class="text-xl font-bold text-blue-600">--</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] uppercase text-gray-400">Em Estoque</p><p id="stock-val" class="text-xl font-bold text-green-600">R$ 0</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] uppercase text-gray-400">Total Itens</p><p id="total-count" class="text-xl font-bold text-gray-800">0</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                    <div class="space-y-6">
                        <div id="admin-stock-panel" class="card bg-stone-50 border-stone-200 hidden">
                            <h2 class="text-sm font-bold text-emerald-800 uppercase mb-4">üõí Lan√ßar Compra (Admin)</h2>
                            <div class="space-y-3">
                                <select id="cat-input" class="input-style" onchange="toggleSizeInput()"><option value="fralda">Fraldas</option><option value="lenco">Len√ßos</option><option value="pomada">Pomadas</option><option value="creme_assadura">Creme Assadura</option><option value="shampoo">Shampoo</option><option value="condicionador">Condicionador</option><option value="sabonete_liq">Sabonete L√≠q.</option><option value="sabao_barra">Sab√£o Barra</option><option value="oleo">√ìleo</option><option value="talco">Talco</option></select>
                                <div id="size-wrapper"><select id="size-input" class="input-style"><option>RN</option><option>P</option><option>M</option><option>G</option><option>XG</option><option>XXG</option></select></div>
                                <input type="number" id="qty-input" placeholder="Qtd (+)" class="input-style">
                                <button onclick="addItem()" class="btn-primary">Adicionar Estoque</button>
                            </div>
                        </div>
                        <button onclick="openDiaperModal()" class="btn-big">Troquei a Alice! üß∑</button>
                    </div>
                    <div class="lg:col-span-2 space-y-4">
                        <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            <button onclick="setFilter('all')" id="filter-all" class="filter-btn filter-active">TUDO</button>
                            <button onclick="setFilter('fraldas')" id="filter-fraldas" class="filter-btn filter-inactive">FRALDAS</button>
                            <button onclick="setFilter('higiene')" id="filter-higiene" class="filter-btn filter-inactive">HIGIENE</button>
                        </div>
                        <div class="card bg-stone-50 min-h-[300px]"><ul id="main-list" class="grid grid-cols-1 gap-3"></ul></div>
                    </div>
                </div>
            </div>

            <div id="tab-saude" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg text-emerald-800">üìè Crescimento</h2><button onclick="toggleHistory()" class="btn-toggle-hist" id="hist-btn-saude">üìÖ Ver Tudo</button></div>
                    <div id="admin-growth-inputs" class="flex gap-2 mb-4 hidden"><input type="number" step="0.1" id="p-in" placeholder="Kg" class="input-style"><input type="number" id="a-in" placeholder="Cm" class="input-style"><button onclick="addGrowth()" class="bg-emerald-700 text-white px-4 rounded-xl font-bold shadow">+</button></div>
                    <div id="growth-log" class="space-y-1 max-h-64 overflow-y-auto"></div>
                </div>
                <div class="card">
                    <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg text-emerald-800">üíä Medicamentos</h2></div>
                    <div class="flex gap-2 mb-4"><input type="text" id="med-in" placeholder="Nome" class="input-style"><button onclick="addMed()" class="bg-emerald-700 text-white px-4 rounded-xl font-bold shadow">+</button></div>
                    <div id="med-log" class="space-y-1 max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-rotina" class="tab-content hidden space-y-6">
                <div class="flex justify-end"><button onclick="toggleHistory()" class="btn-toggle-hist" id="hist-btn-rotina">üìÖ Ver Hist√≥rico Completo</button></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="font-bold text-lg text-emerald-800 mb-4">ü§± Amamenta√ß√£o</h2>
                        <div class="grid grid-cols-2 gap-3 mb-4"><button onclick="regFeed('Esq')" class="bg-white border-2 border-pink-200 text-pink-700 font-bold py-3 rounded-xl hover:bg-pink-50">ESQUERDO</button><button onclick="regFeed('Dir')" class="bg-white border-2 border-blue-200 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-50">DIREITO</button></div>
                        <div id="feed-log" class="space-y-1 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="card">
                        <h2 class="font-bold text-lg text-emerald-800 mb-4">üò¥ Soneca</h2>
                        <div class="bg-stone-50 p-4 rounded-2xl mb-4 text-center border border-stone-200"><p id="nap-status-text" class="text-sm text-gray-500 mb-2 font-medium">Acordada</p><button id="nap-toggle-btn" onclick="toggleNap()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow">üåô INICIAR</button></div>
                        <div id="nap-log" class="space-y-1 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="font-bold text-lg text-emerald-800 mb-4">üìñ Di√°rio</h2>
                    <textarea id="diary-in" class="input-style h-20 mb-2 resize-none" placeholder="Escreva..."></textarea>
                    <button onclick="addDiary()" class="btn-primary">Salvar</button>
                    <div id="diary-log" class="mt-4 space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-wish" class="tab-content hidden">
                <div class="card max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6"><h2 class="font-bold text-lg text-emerald-800">‚ú® Desejos</h2><div class="flex gap-2"><button onclick="exportWishlistCSV()" class="text-[10px] bg-green-100 text-green-700 px-3 py-2 rounded-lg font-bold">CSV</button><button onclick="exportWishlistPDF()" class="text-[10px] bg-red-100 text-red-700 px-3 py-2 rounded-lg font-bold">PDF</button></div></div>
                    <div id="admin-wish-inputs" class="flex gap-2 mb-6 hidden"><input type="text" id="wish-in" class="input-style" placeholder="Item..."><button onclick="addWish()" class="bg-emerald-700 text-white px-4 rounded-xl font-bold shadow">+</button></div>
                    <div id="wish-log" class="space-y-2"></div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    <div class="space-y-6">
                        <div class="card border-l-4 border-l-red-500">
                            <h2 class="text-lg font-bold text-red-700 mb-4">üè• Dados M√©dicos</h2>
                            <div class="space-y-4">
                                <div><label class="label-style">Tipo Sangu√≠neo</label><select id="prof-blood" class="input-style" onchange="saveProfile()"><option value="">Selecione...</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option><option value="O+">O+</option><option value="O-">O-</option></select></div>
                                <div><label class="label-style">Alergias</label><textarea id="prof-allergy" class="input-style h-20 bg-red-50 border-red-200" placeholder="Ex: Prote√≠na do leite..." onblur="saveProfile()"></textarea></div>
                                <div><label class="label-style">N¬∫ Carteirinha</label><input type="text" id="prof-insurance" class="input-style" placeholder="000.000.000" onblur="saveProfile()"></div>
                                <div><label class="label-style">Hospital</label><input type="text" id="prof-hospital" class="input-style" placeholder="Nome do Hospital" onblur="saveProfile()"></div>
                            </div>
                        </div>
                        <div class="card border-l-4 border-l-blue-500">
                            <h2 class="text-lg font-bold text-blue-700 mb-4">üìû Contatos & Endere√ßo</h2>
                            <div class="space-y-4">
                                <div><label class="label-style">Pediatra</label><input type="text" id="prof-pediatrician" class="input-style" placeholder="Dr. Nome - Tel" onblur="saveProfile()"></div>
                                <div><label class="label-style">M√£e (Tel)</label><input type="text" id="prof-mom" class="input-style" placeholder="(11) 99999-9999" onblur="saveProfile()"></div>
                                <div><label class="label-style">Pai (Tel)</label><input type="text" id="prof-dad" class="input-style" placeholder="(11) 99999-9999" onblur="saveProfile()"></div>
                                <div><label class="label-style">Endere√ßo</label><textarea id="prof-address" class="input-style h-24" placeholder="Rua, N√∫mero, Bairro" onblur="saveProfile()"></textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-l-4 border-l-stone-500">
                        <h2 class="text-lg font-bold text-stone-700 mb-4 flex justify-between">üìÇ Documentos Digitais<span class="text-xs font-normal text-gray-400 pt-1">Max: 1MB</span></h2>
                        <div id="admin-docs-panel" class="mb-4 bg-stone-50 p-4 rounded-xl border border-stone-200 border-dashed hidden">
                            <label class="label-style">Adicionar Foto (Admin)</label>
                            <input type="file" id="doc-upload" accept="image/*" class="w-full text-sm text-gray-500">
                            <input type="text" id="doc-name" placeholder="Nome (Ex: RG)" class="input-style mt-2">
                            <button onclick="uploadDoc()" class="btn-primary mt-2 text-sm py-2">Salvar</button>
                        </div>
                        <h3 class="label-style mb-2">Salvos</h3>
                        <div id="doc-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO DE USU√ÅRIOS ---
        // ! IMPORTANTE: ADICIONE OS E-MAILS DOS PAIS AQUI !
        const ADMINS = [
            "hugoclemenc@paidaalice.com", 
            "maria@maedaalice.com"
        ];
        
        const DATA_NASCIMENTO = new Date("2026-04-23T00:00:00"); 
        const firebaseConfig = { apiKey: "AIzaSyDxoVagw1NT72ywjK_svZeBt2beCowoZx8", authDomain: "alice-erp.firebaseapp.com", databaseURL: "https://alice-erp-default-rtdb.firebaseio.com", projectId: "alice-erp", storageBucket: "alice-erp.firebasestorage.app", messagingSenderId: "758898829901", appId: "1:758898829901:web:98125a74abcdf144930a04", measurementId: "G-64NHJVVMB6" };
        firebase.initializeApp(firebaseConfig); const auth = firebase.auth(); const db = firebase.database();

        const market = { fraldas: { 'RN': 200, 'P': 800, 'M': 1300, 'G': 1600, 'XG': 800, 'XXG': 500 }, higiene: { 'lenco': 120, 'pomada': 24, 'creme_assadura': 12, 'shampoo': 10, 'condicionador': 8, 'sabonete_liq': 15, 'sabao_barra': 20, 'oleo': 5, 'talco': 3 } };
        const prices = { fralda: 1.15, lenco: 12, pomada: 25, creme_assadura: 30, shampoo: 18, condicionador: 20, sabonete_liq: 24, sabao_barra: 5, oleo: 30, talco: 15 };
        const labels = { lenco: 'Len√ßos', pomada: 'Pomada', creme_assadura: 'Creme', shampoo: 'Shampoo', condicionador: 'Condicionador', sabonete_liq: 'Sabonete L√≠q.', sabao_barra: 'Sab√£o Barra', oleo: '√ìleo', talco: 'Talco' };
        
        let currentFilter = 'all';
        let showAllHistory = false;
        let lastDataSnapshot = {};
        let isUserAdmin = false;

        // --- REL√ìGIO ---
        function updateClock() {
            const now=new Date(), diff=DATA_NASCIMENTO-now, el=document.getElementById('timer-val');
            if(diff>0){const d=Math.floor(diff/86400000), h=Math.floor((diff%86400000)/3600000); el.innerText=`Faltam: ${d}d ${h}h`; el.classList.replace('text-emerald-600','text-orange-500');}
            else{const a=now-DATA_NASCIMENTO, d=Math.floor(a/86400000), m=Math.floor(d/30), ds=d%30; el.innerText=`Idade: ${m}m ${ds}d`; el.classList.replace('text-orange-500','text-emerald-600');}
        }
        setInterval(updateClock,1000); updateClock();

        // --- AUTH & PERMISS√ïES ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                isUserAdmin = ADMINS.includes(user.email.toLowerCase());
                applyPermissions(isUserAdmin);
                document.getElementById('user-role-display').innerText = isUserAdmin ? "Perfil: Admin (Pai/M√£e)" : "Perfil: Visitante";
                
                startSync();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        function applyPermissions(isAdmin) {
            // Elementos visuais para esconder/mostrar
            const adminElements = [
                'admin-stock-panel',   // Compra Estoque
                'admin-growth-inputs', // Crescimento
                'admin-wish-inputs',   // Wishlist Adicionar
                'admin-docs-panel'     // Docs Upload
            ];
            adminElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (isAdmin) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });

            // Bloquear inputs do perfil se n√£o for admin
            const profileInputs = document.querySelectorAll('#tab-profile input, #tab-profile select, #tab-profile textarea');
            profileInputs.forEach(input => {
                // N√£o bloqueia o upload de arquivo aqui, pois ele j√° est√° dentro do panel escondido acima
                if(!input.closest('#admin-docs-panel')) {
                    input.disabled = !isAdmin;
                }
            });
        }

        async function handleLogin(){try{await auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-password').value);}catch(e){document.getElementById('login-error').innerText=e.message;document.getElementById('login-error').classList.remove('hidden');}}
        function handleLogout(){auth.signOut();}

        function startSync() {
            db.ref().on('value', snap => {
                const data = snap.val() || {}; lastDataSnapshot = data;
                renderEstoque(data.stock||{}, data.usageLogs||{}); renderSaude(data.growth||{}, data.meds||{});
                renderRotina(data.feeds||{}, data.diary||{}, data.naps||{}, data.napStatus||{});
                renderWishes(data.wishes||{}); renderProfile(data.profile||{}); renderDocs(data.documents||{});
            });
        }

        // --- RENDERS ---
        function renderSaude(growth, meds) {
            const gl=document.getElementById('growth-log');gl.innerHTML='';
            Object.entries(growth).reverse().filter(([k,v])=>isRecent(v.date)).forEach(([k,g])=>{
                const delBtn = isUserAdmin ? `<button onclick="firebase.database().ref('growth/${k}').remove()" class="btn-delete">‚úï</button>` : '';
                gl.innerHTML+=`<div class="list-item-row"><span>üìÖ ${fmtDate(g.date)} <b class="ml-2">${g.p}kg</b> | <b>${g.a}cm</b></span>${delBtn}</div>`
            });
            const ml=document.getElementById('med-log');ml.innerHTML='';
            Object.entries(meds).reverse().filter(([k,v])=>isRecent(v.d)).forEach(([k,m])=>{
                // Meds: Delete para TODOS
                const delBtn = `<button onclick="firebase.database().ref('meds/${k}').remove()" class="btn-delete">‚úï</button>`;
                ml.innerHTML+=`<div class="list-item-row"><span>üíä <b>${m.t}</b> - ${fmtDate(m.d)}</span>${delBtn}</div>`
            });
        }

        function renderDocs(docs) {
            const l=document.getElementById('doc-list'); l.innerHTML=''; if(!docs){l.innerHTML='<p class="text-xs">Vazio.</p>';return;}
            Object.entries(docs).reverse().forEach(([k,d])=>{ 
                const delBtn = isUserAdmin ? `<button onclick="firebase.database().ref('documents/${k}').remove()" class="text-red-400 hover:text-red-600 px-2 font-bold">‚úï</button>` : '';
                l.innerHTML+=`<div class="flex justify-between items-center bg-stone-50 p-3 rounded-xl border"><div class="flex gap-3"><span class="text-xl">üìÑ</span><div><p class="text-sm font-bold">${d.name}</p><p class="text-[10px]">${new Date(d.date).toLocaleDateString()}</p></div></div><div class="flex gap-2"><button onclick="const w=window.open();w.document.write('<img src=\\'${d.data}\\' width=100%>');" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded">Ver</button>${delBtn}</div></div>`; 
            });
        }

        function renderEstoque(stock, logsObj) {
            const l=document.getElementById('main-list');let f=0,c=0,cnt=0;l.innerHTML='';
            const createItem=(k,n,q,g,h)=>{
                const cl=g>0?'border-red-400 bg-red-50 text-red-500':'border-emerald-400 bg-emerald-50 text-emerald-600';
                const editBtn = isUserAdmin ? `<button onclick="editItem('${k}',${q})" class="p-2 bg-stone-100 rounded text-gray-400 hover:text-emerald-600">‚úèÔ∏è</button>` : '';
                return`<li class="bg-white p-3 rounded-2xl border border-stone-200 shadow-sm flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold ${cl}">${g>0?'!':'‚úì'}</div><div><p class="font-bold ${h?'text-emerald-700':'text-gray-800'}">${n}</p><p class="text-[10px] text-gray-500">${g>0?`Faltam ${g}`:'Ok'}</p></div></div><div class="flex items-center gap-2"><span class="font-bold text-gray-700">${q}<small class="text-gray-400 font-normal">un</small></span>${editBtn}</div></li>`
            };
            if(currentFilter==='all'||currentFilter==='fraldas')for(let s in market.fraldas){const h=stock[s]||0,g=Math.max(0,market.fraldas[s]-h);f+=g*prices.fralda;c+=h*prices.fralda;cnt+=h;l.innerHTML+=createItem(s,`Fralda ${s}`,h,g,false)}
            if(currentFilter==='all'||currentFilter==='higiene')for(let i in market.higiene){const h=stock[i]||0,g=Math.max(0,market.higiene[i]-h);f+=g*(prices[i]||0);c+=h*(prices[i]||0);cnt+=h;l.innerHTML+=createItem(i,labels[i],h,g,true)}
            
            const logs = Object.values(logsObj).sort((a,b) => { const dateA = a.date ? new Date(a.date) : new Date(a); const dateB = b.date ? new Date(b.date) : new Date(b); return dateA - dateB; });
            if(logs.length > 1){ const getD = (i) => i.date ? new Date(i.date) : new Date(i); const diffMs = Math.abs(getD(logs[logs.length-1]) - getD(logs[0])); const days = Math.max(1, diffMs / 86400000); document.getElementById('media-val').innerText = (logs.length/days).toFixed(1)+'/d'; } else { document.getElementById('media-val').innerText = '--'; }
            document.getElementById('future-cost').innerText='R$ '+f.toFixed(0);document.getElementById('stock-val').innerText='R$ '+c.toFixed(0);document.getElementById('total-count').innerText=cnt;
        }

        function renderWishes(w){
            const l=document.getElementById('wish-log');l.innerHTML='';
            Object.entries(w).forEach(([k,v])=>{
                const delBtn = isUserAdmin ? `<button onclick="firebase.database().ref('wishes/${k}').remove()" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">‚úì J√° Tenho</button>` : '';
                l.innerHTML+=`<div class="list-item-row"><span class="font-medium text-gray-700">${v.t}</span>${delBtn}</div>`
            });
        }

        // --- UI ---
        function toggleMenu(){const sb=document.getElementById('sidebar'), ov=document.getElementById('overlay'); sb.classList.toggle('open'); ov.classList.toggle('open');}
        function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); const l=document.getElementById('link-'+t); if(l)l.classList.add('active'); if(document.getElementById('sidebar').classList.contains('open')) toggleMenu();}
        function toggleHistory(){showAllHistory=!showAllHistory; const txt=showAllHistory?"üìÖ Ver Menos (7 dias)":"üìÖ Ver Hist√≥rico Completo"; if(document.getElementById('hist-btn-saude'))document.getElementById('hist-btn-saude').innerText=txt; if(document.getElementById('hist-btn-rotina'))document.getElementById('hist-btn-rotina').innerText=txt; renderRotina(lastDataSnapshot.feeds||{}, lastDataSnapshot.diary||{}, lastDataSnapshot.naps||{}, lastDataSnapshot.napStatus||{}); renderSaude(lastDataSnapshot.growth||{}, lastDataSnapshot.meds||{});}
        function openDiaperModal(){ document.getElementById('diaper-modal').classList.add('open'); }
        function closeDiaperModal(){ document.getElementById('diaper-modal').classList.remove('open'); }
        function confirmDiaperUsage(size) { firebase.database().ref('stock/' + size).transaction(c => (c || 0) > 0 ? c - 1 : 0); firebase.database().ref('usageLogs').push().set({ date: new Date().toISOString(), type: `Troca Fralda (${size})` }); closeDiaperModal(); }
        function uploadDoc() { const fi=document.getElementById('doc-upload'), ni=document.getElementById('doc-name'), f=fi.files[0]; if(!f)return alert("Selecione um arquivo!"); if(f.size>1024*1024)return alert("M√°x 1MB!"); const r=new FileReader(); r.onload=function(e){ firebase.database().ref('documents').push().set({name:ni.value||"Doc", data:e.target.result, date:new Date().toISOString()}); fi.value=''; ni.value=''; }; r.readAsDataURL(f); }
        
        // --- DEMAIS ---
        function saveProfile(){
            if(!isUserAdmin) return; // Seguran√ßa extra no front
            const p={blood:document.getElementById('prof-blood').value,allergy:document.getElementById('prof-allergy').value,insurance:document.getElementById('prof-insurance').value,hospital:document.getElementById('prof-hospital').value,pediatrician:document.getElementById('prof-pediatrician').value,mom:document.getElementById('prof-mom').value,dad:document.getElementById('prof-dad').value,address:document.getElementById('prof-address').value};firebase.database().ref('profile').set(p);
        }
        function renderProfile(p){if(!p)return;const f=(i,v)=>{const e=document.getElementById(i);if(e&&document.activeElement!==e)e.value=v||''};f('prof-blood',p.blood);f('prof-allergy',p.allergy);f('prof-insurance',p.insurance);f('prof-hospital',p.hospital);f('prof-pediatrician',p.pediatrician);f('prof-mom',p.mom);f('prof-dad',p.dad);f('prof-address',p.address);}
        function fmtDate(i){if(!i)return'';return new Date(i).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}).replace(',',' √†s');}
        function isRecent(i){if(showAllHistory)return true;if(!i)return false;const d=new Date(i),a=new Date();a.setDate(a.getDate()-7);return d>=a;}
        function renderRotina(feeds,diary,naps,napStatus){const fl=document.getElementById('feed-log');fl.innerHTML='';Object.entries(feeds).reverse().filter(([k,v])=>isRecent(v.d)).forEach(([k,v])=>{fl.innerHTML+=`<div class="list-item-row"><span class="text-gray-600">ü§± <b>${v.s}</b> - ${fmtDate(v.d)}</span><button onclick="firebase.database().ref('feeds/${k}').remove()" class="btn-delete">‚úï</button></div>`});const nl=document.getElementById('nap-log');nl.innerHTML='';Object.entries(naps).reverse().filter(([k,v])=>isRecent(v.start)).forEach(([k,v])=>{nl.innerHTML+=`<div class="list-item-row"><span class="text-gray-600">üò¥ <b>${v.duration}min</b> - ${fmtDate(v.start)}</span><button onclick="firebase.database().ref('naps/${k}').remove()" class="btn-delete">‚úï</button></div>`});const nb=document.getElementById('nap-toggle-btn'),nt=document.getElementById('nap-status-text');if(napStatus&&napStatus.sleeping){const m=Math.round((new Date()-new Date(napStatus.start))/60000);nb.innerText="‚òÄÔ∏è ACORDOU";nb.className="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow";nt.innerText=`Dormindo h√° ${m} min`;}else{nb.innerText="üåô INICIAR";nb.className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow";nt.innerText="Acordada";}const dl=document.getElementById('diary-log');dl.innerHTML='';Object.entries(diary).reverse().filter(([k,v])=>isRecent(v.d)).forEach(([k,d])=>{dl.innerHTML+=`<div class="bg-white p-3 rounded-xl border-l-4 border-emerald-500 shadow-sm relative text-sm"><div class="italic text-gray-600 pr-6">"${d.t}"</div><div class="text-[10px] text-gray-400 mt-1 not-italic">${fmtDate(d.d)}</div><button onclick="firebase.database().ref('diary/${k}').remove()" class="absolute top-1 right-1 text-red-300 hover:text-red-500 font-bold px-2">‚úï</button></div>`});}
        function toggleNap(){firebase.database().ref('napStatus').once('value',s=>{const st=s.val();if(st&&st.sleeping){const end=new Date();const m=Math.round((end-new Date(st.start))/60000);firebase.database().ref('naps').push().set({start:st.start,end:end.toISOString(),duration:m});firebase.database().ref('napStatus').set({sleeping:false})}else{firebase.database().ref('napStatus').set({sleeping:true,start:new Date().toISOString()})}})}
        function editItem(k,q){let n=prompt(`Nova qtd:`,q);if(n!==null&&n.trim()!=="")firebase.database().ref('stock/'+k).set(parseInt(n))}
        function addItem(){const c=document.getElementById('cat-input').value;const k=c==='fralda'?document.getElementById('size-input').value:c;const q=parseInt(document.getElementById('qty-input').value)||0;if(q>0){firebase.database().ref('stock/'+k).transaction(v=>(v||0)+q);document.getElementById('qty-input').value=''}}
        function registerUsage(){firebase.database().ref('usageLogs').push().set(new Date().toISOString())}
        function addGrowth(){const p=document.getElementById('p-in').value,a=document.getElementById('a-in').value;if(p&&a)firebase.database().ref('growth').push().set({p,a,date:new Date().toISOString()})}
        function addMed(){const t=document.getElementById('med-in').value;if(t)firebase.database().ref('meds').push().set({t,d:new Date().toISOString()})}
        function regFeed(s){firebase.database().ref('feeds').push().set({s,d:new Date().toISOString()})}
        function addDiary(){const t=document.getElementById('diary-in').value;if(t)firebase.database().ref('diary').push().set({t,d:new Date().toISOString()})}
        function addWish(){const t=document.getElementById('wish-in').value;if(t)firebase.database().ref('wishes').push().set({t})}
        function setFilter(f){currentFilter=f;document.querySelectorAll('.filter-btn').forEach(b=>{b.classList.replace('filter-active','filter-inactive');if(b.id==='filter-'+f)b.classList.replace('filter-inactive','filter-active')});firebase.database().ref().once('value',s=>renderEstoque(s.val().stock||{},s.val().usageLogs||{}))}
        function toggleSizeInput(){document.getElementById('size-wrapper').classList.toggle('hidden',document.getElementById('cat-input').value!=='fralda')}
        function toggleAvoMode(){document.body.classList.toggle('text-xl')}
        function exportWishlistCSV(){firebase.database().ref('wishes').once('value',s=>{const d=s.val()||{};let c="Item\n";Object.values(d).forEach(w=>c+=`"${w.t}"\n`);const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(["\ufeff"+c],{type:'text/csv'}));a.download="wishlist.csv";a.click()})}
        async function exportWishlistPDF(){const {jsPDF}=window.jspdf;const d=new jsPDF();d.setFontSize(18);d.text("Desejos Alice",14,20);const s=await firebase.database().ref('wishes').once('value');const r=Object.values(s.val()||{}).map(w=>[w.t]);if(!r.length)return alert("Vazia!");d.autoTable({body:r,startY:25});d.save('wishlist.pdf')}
    </script>
</body>
</html>
