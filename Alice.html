<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice Ultimate ERP üçº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { @apply bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-all; }
        .card { @apply bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700; }
        .input-style { @apply w-full border dark:border-gray-600 rounded-xl p-2 text-sm dark:bg-gray-700; }
        .tab-btn { @apply flex-1 py-2 rounded-lg font-bold text-xs transition-all text-center; }
        .tab-active { @apply bg-pink-500 text-white shadow-md; }
        .tab-inactive { @apply bg-gray-200 dark:bg-gray-700 text-gray-500; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="pb-24">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-pink-600 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <span class="text-5xl">üë∂</span>
                <h2 class="text-2xl font-bold text-pink-600 mt-2">Alice ERP Login</h2>
            </div>
            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="E-mail" class="input-style border-gray-300">
                <input type="password" id="login-password" placeholder="Senha" class="input-style border-gray-300">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold hover:bg-pink-700 transition">Acessar Painel</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"></p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="sticky top-0 z-50 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-b dark:border-gray-700 p-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold text-pink-600">Alice Ultimate</h1>
                <div class="flex gap-2 items-center">
                    <button onclick="toggleAvoMode()" id="avo-btn" class="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold uppercase">Av√≥s: OFF</button>
                    <button onclick="toggleDarkMode()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full">üåì</button>
                    <button onclick="handleLogout()" class="text-xs text-gray-400 underline">Sair</button>
                </div>
            </div>
            <div class="max-w-6xl mx-auto flex gap-1 mt-4 overflow-x-auto">
                <button onclick="switchTab('estoque')" id="btn-estoque" class="tab-btn tab-active">üì¶ Estoque</button>
                <button onclick="switchTab('saude')" id="btn-saude" class="tab-btn tab-inactive">üè• Sa√∫de</button>
                <button onclick="switchTab('rotina')" id="btn-rotina" class="tab-btn tab-inactive">‚è∞ Rotina</button>
                <button onclick="switchTab('ajustes')" id="btn-ajustes" class="tab-btn tab-inactive">‚öôÔ∏è Wishlist</button>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-4 space-y-6">

            <div id="tab-estoque" class="tab-content space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="card bg-pink-500 text-white border-none text-center">
                        <p class="text-[10px] uppercase opacity-80">Falta Comprar</p>
                        <p id="future-cost" class="text-lg font-bold">R$ 0</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-[10px] text-gray-400 uppercase">M√©dia Trocas</p>
                        <p id="media-val" class="text-lg font-bold text-blue-500">--</p>
                    </div>
                    <div class="card text-center border-l-4 border-l-green-500">
                        <p class="text-[10px] text-gray-400 uppercase">Em Estoque</p>
                        <p id="stock-val" class="text-lg font-bold text-green-600">R$ 0</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-[10px] text-gray-400 uppercase">Total Itens</p>
                        <p id="total-count" class="text-lg font-bold">0</p>
                    </div>
                </div>

                <button onclick="registerUsage()" class="w-full bg-blue-600 text-white font-black py-8 rounded-3xl shadow-lg active:scale-95 transition text-2xl uppercase">
                    Troquei a Alice! üß∑
                </button>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <h2 class="font-bold mb-4">üì• Lan√ßar Compra</h2>
                        <div class="space-y-3">
                            <select id="cat-input" class="input-style" onchange="toggleSizeInput()">
                                <option value="fralda">Fraldas</option>
                                <option value="lenco">Len√ßos</option>
                                <option value="pomada">Pomadas</option>
                                <option value="shampoo">Shampoo</option>
                                <option value="sabonete_liq">Sabonete L√≠q.</option>
                            </select>
                            <div id="size-wrapper">
                                <select id="size-input" class="input-style"><option>RN</option><option>P</option><option>M</option><option>G</option><option>XG</option></select>
                            </div>
                            <input type="number" id="qty-input" placeholder="Quantidade" class="input-style">
                            <button onclick="addItem()" class="w-full bg-pink-500 text-white py-2 rounded-xl font-bold">Salvar</button>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="font-bold mb-4">‚ö†Ô∏è Alertas de Estoque</h2>
                        <div id="alerts-list" class="space-y-2"></div>
                    </div>
                </div>

                <div class="card overflow-x-auto">
                    <table class="w-full text-xs"><tbody id="main-table"></tbody></table>
                </div>
            </div>

            <div id="tab-saude" class="tab-content hidden space-y-4">
                <div class="card">
                    <h2 class="font-bold mb-4">üìè Crescimento (Peso/Altura)</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="number" step="0.1" id="p-in" placeholder="Kg" class="input-style">
                        <input type="number" id="a-in" placeholder="Cm" class="input-style">
                        <button onclick="addGrowth()" class="bg-blue-500 text-white px-4 rounded-xl">+</button>
                    </div>
                    <div id="growth-log" class="text-xs space-y-1"></div>
                </div>
                <div class="card">
                    <h2 class="font-bold mb-4">üíä Medicamentos Aplicados</h2>
                    <div class="flex gap-2">
                        <input type="text" id="med-in" placeholder="Ex: Paracetamol" class="input-style">
                        <button onclick="addMed()" class="bg-purple-500 text-white px-4 rounded-xl">+</button>
                    </div>
                    <div id="med-log" class="mt-4 text-[10px] space-y-1"></div>
                </div>
            </div>

            <div id="tab-rotina" class="tab-content hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="regFeed('Esq')" class="card bg-pink-50 dark:bg-pink-900/20 text-pink-600 font-bold py-6">ü§± ESQUERDO</button>
                    <button onclick="regFeed('Dir')" class="card bg-blue-50 dark:bg-blue-900/20 text-blue-600 font-bold py-6">ü§± DIREITO</button>
                </div>
                <p id="last-feed-txt" class="text-center text-xs italic text-gray-400">√öltima mamada: --</p>
                
                <div class="card text-center">
                    <button id="nap-btn" onclick="toggleNap()" class="w-full bg-indigo-600 text-white py-6 rounded-2xl font-bold text-xl">Soneca: INICIAR</button>
                </div>
                
                <div class="card">
                    <h2 class="font-bold mb-2 italic">üìñ Momentos Especiais</h2>
                    <textarea id="diary-in" class="input-style h-20 mb-2" placeholder="O que ela fez de fofo hoje?"></textarea>
                    <button onclick="addDiary()" class="w-full bg-pink-500 text-white py-2 rounded-xl font-bold">Salvar Di√°rio</button>
                    <div id="diary-log" class="mt-4 space-y-2"></div>
                </div>
            </div>

            <div id="tab-ajustes" class="tab-content hidden space-y-4">
                <div class="card">
                    <h2 class="font-bold mb-4">‚ú® Lista de Desejos</h2>
                    <div class="flex gap-2">
                        <input type="text" id="wish-in" class="input-style" placeholder="Algo para comprar...">
                        <button onclick="addWish()" class="bg-pink-500 text-white px-4 rounded-xl">+</button>
                    </div>
                    <div id="wish-log" class="mt-4 space-y-2"></div>
                </div>
                <button onclick="exportCSV()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Exportar para Excel (CSV)</button>
            </div>

        </main>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDxoVagw1NT72ywjK_svZeBt2beCowoZx8",
            authDomain: "alice-erp.firebaseapp.com",
            databaseURL: "https://alice-erp-default-rtdb.firebaseio.com",
            projectId: "alice-erp",
            storageBucket: "alice-erp.firebasestorage.app",
            messagingSenderId: "758898829901",
            appId: "1:758898829901:web:98125a74abcdf144930a04",
            measurementId: "G-64NHJVVMB6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // REGRAS DE MERCADO
        const market = {
            fraldas: { 'RN': 200, 'P': 800, 'M': 1300, 'G': 1600, 'XG': 800 },
            higiene: { 'lenco': 120, 'pomada': 24, 'shampoo': 10, 'sabonete_liq': 15 }
        };
        const prices = { fralda: 1.15, lenco: 12, pomada: 25, shampoo: 18, sabonete_liq: 24 };

        // AUTH MONITOR
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                startSync();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try { await auth.signInWithEmailAndPassword(email, pass); } 
            catch(e) { 
                const err = document.getElementById('login-error');
                err.innerText = "Erro: " + e.message;
                err.classList.remove('hidden');
            }
        }

        function handleLogout() { auth.signOut(); }

        // SYNC E RENDER
        function startSync() {
            db.ref().on('value', snap => {
                const data = snap.val() || {};
                renderEstoque(data.stock || {}, data.usageLogs || {});
                renderSaude(data.growth || {}, data.meds || {});
                renderRotina(data.feeds || {}, data.diary || {});
                renderWishes(data.wishes || {});
            });
        }

        function renderEstoque(stock, logsObj) {
            const table = document.getElementById('main-table');
            const alerts = document.getElementById('alerts-list');
            let future = 0, current = 0, count = 0;
            table.innerHTML = ''; alerts.innerHTML = '';
            
            // Fraldas
            for(let s in market.fraldas) {
                const has = stock[s] || 0;
                const gap = Math.max(0, market.fraldas[s] - has);
                future += gap * prices.fralda;
                current += has * prices.fralda;
                count += has;
                table.innerHTML += `<tr class="border-b dark:border-gray-700"><td class="py-3 font-bold text-pink-500">${s}</td><td>${has} un</td><td class="text-right text-gray-400">Faltam ${gap}</td></tr>`;
                if(has > 0 && has < 50) alerts.innerHTML += `<div class="p-2 bg-red-100 text-red-700 rounded-lg text-[10px] font-bold">üî¥ Fralda ${s} em estado cr√≠tico!</div>`;
            }

            const logs = Object.values(logsObj);
            if(logs.length > 1) {
                const d = Math.max(1, (new Date(logs[logs.length-1]) - new Date(logs[0]))/86400000);
                document.getElementById('media-val').innerText = (logs.length/d).toFixed(1)+'/d';
            }
            document.getElementById('future-cost').innerText = 'R$ '+future.toFixed(0);
            document.getElementById('stock-val').innerText = 'R$ '+current.toFixed(0);
            document.getElementById('total-count').innerText = count;
        }

        function renderSaude(growth, meds) {
            const gLog = document.getElementById('growth-log'); gLog.innerHTML = '';
            Object.values(growth).reverse().slice(0,5).forEach(g => {
                gLog.innerHTML += `<div class="p-2 bg-gray-50 dark:bg-gray-700 rounded"><b>${g.date}:</b> ${g.p}kg / ${g.a}cm</div>`;
            });
            const mLog = document.getElementById('med-log'); mLog.innerHTML = '';
            Object.values(meds).reverse().slice(0,5).forEach(m => {
                mLog.innerHTML += `<div class="p-1 border-b dark:border-gray-700">üíä ${m.t} - <span class="text-gray-400">${m.d}</span></div>`;
            });
        }

        function renderRotina(feeds, diary) {
            const last = Object.values(feeds).pop();
            if(last) document.getElementById('last-feed-txt').innerText = `√öltima: ${last.s} √†s ${last.d.split(', ')[1]}`;
            const dLog = document.getElementById('diary-log'); dLog.innerHTML = '';
            Object.values(diary).reverse().slice(0,3).forEach(d => {
                dLog.innerHTML += `<div class="p-3 bg-pink-50 dark:bg-pink-900/20 rounded-xl text-xs border-l-4 border-pink-400">"${d.t}"</div>`;
            });
        }

        function renderWishes(wishes) {
            const wLog = document.getElementById('wish-log'); wLog.innerHTML = '';
            Object.entries(wishes).forEach(([k, v]) => {
                wLog.innerHTML += `<div class="flex justify-between items-center text-sm p-2 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-xl"><span>${v.t}</span><button onclick="delWish('${k}')" class="text-red-500">‚úï</button></div>`;
            });
        }

        // ESCRITA FIREBASE
        function registerUsage() { db.ref('usageLogs').push().set(new Date().toISOString()); }
        
        function addItem() {
            const cat = document.getElementById('cat-input').value;
            const key = cat === 'fralda' ? document.getElementById('size-input').value : cat;
            const qty = parseInt(document.getElementById('qty-input').value) || 0;
            db.ref('stock/'+key).transaction(c => (c||0) + qty);
            document.getElementById('qty-input').value = '';
        }

        function addGrowth() {
            const p = document.getElementById('p-in').value;
            const a = document.getElementById('a-in').value;
            if(p && a) db.ref('growth').push().set({p, a, date: new Date().toLocaleDateString()});
        }

        function addMed() {
            const t = document.getElementById('med-in').value;
            if(t) db.ref('meds').push().set({t, d: new Date().toLocaleString()});
            document.getElementById('med-in').value = '';
        }

        function regFeed(s) { db.ref('feeds').push().set({s, d: new Date().toLocaleString()}); }

        function addDiary() {
            const t = document.getElementById('diary-in').value;
            if(t) db.ref('diary').push().set({t, d: new Date().toLocaleDateString()});
            document.getElementById('diary-in').value = '';
        }

        function addWish() {
            const t = document.getElementById('wish-in').value;
            if(t) db.ref('wishes').push().set({t});
            document.getElementById('wish-in').value = '';
        }
        function delWish(k) { db.ref('wishes/'+k).remove(); }

        // UI HELPERS
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.replace('tab-active', 'tab-inactive');
                if(b.id === 'btn-'+t) b.classList.replace('tab-inactive', 'tab-active');
            });
        }

        function toggleSizeInput() { document.getElementById('size-wrapper').classList.toggle('hidden', document.getElementById('cat-input').value !== 'fralda'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        function toggleAvoMode() {
            const is = document.body.classList.toggle('text-xl');
            document.getElementById('avo-btn').innerText = is ? "Av√≥s: ON" : "Av√≥s: OFF";
        }
        
        let nap = false;
        function toggleNap() {
            nap = !nap;
            const b = document.getElementById('nap-btn');
            b.innerText = nap ? "Soneca: EM CURSO üò¥" : "Soneca: INICIAR";
            b.classList.toggle('bg-orange-500');
        }

        function exportCSV() {
            db.ref().once('value', snap => {
                const d = snap.val() || {};
                let csv = "Item,Qtd\n";
                for(let k in d.stock) csv += `${k},${d.stock[k]}\n`;
                const blob = new Blob(["\ufeff"+csv], {type:'text/csv'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'estoque_alice.csv';
                a.click();
            });
        }
    </script>
</body>
</html>